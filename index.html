<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Horas Complementarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-primary text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-2xl font-bold">Generador de Horas Complementarias</h1>
                        <p class="text-primary-100 mt-1">Sistema para documentos semanales del docente</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="guardarBtn" class="bg-green-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors text-sm">
                            💾 Guardar
                        </button>
                        <button id="cargarBtn" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">
                            📂 Cargar
                        </button>
                        <button id="exportarDatosBtn" class="bg-purple-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors text-sm">
                            📤 Exportar Datos
                        </button>
                        <button id="importarDatosBtn" class="bg-orange-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-orange-700 transition-colors text-sm">
                            📥 Importar
                        </button>
                        <button id="nuevaSemanBtn" class="bg-white text-primary px-3 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors text-sm">
                            🆕 Nueva Semana
                        </button>
                        <button id="exportarBtn" class="bg-primary-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-primary-700 transition-colors disabled:opacity-50 text-sm" disabled>
                            📄 PDF
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Información del Docente -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Información del Docente</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Docente:</label>
                        <input type="text" id="docente" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" 
                               placeholder="Ing. Kevin Chica MSc." value="Ing. Kevin Chica MSc.">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tutoría:</label>
                        <input type="text" id="tutoria" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" 
                               placeholder="5to EGB" value="5to EGB">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Año Lectivo:</label>
                        <input type="text" id="anoLectivo" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" 
                               placeholder="2024 - 2025" value="2024 - 2025">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Asignaturas:</label>
                        <input type="text" id="asignaturas" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base" 
                               placeholder="L.L, MAT, CCNN, E.S" value="L.L, MAT, CCNN, E.S">
                    </div>
                </div>
            </div>

            <!-- Selector de Semana -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Configuración de Semana</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Número de Semana:</label>
                        <select id="numeroSemana" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            <option value="1">Semana 1</option>
                            <option value="2">Semana 2</option>
                            <option value="3">Semana 3</option>
                            <option value="4">Semana 4</option>
                            <option value="5">Semana 5</option>
                            <option value="6">Semana 6</option>
                            <option value="7">Semana 7</option>
                            <option value="8">Semana 8</option>
                            <option value="9">Semana 9</option>
                            <option value="10">Semana 10</option>
                            <option value="11">Semana 11</option>
                            <option value="12">Semana 12</option>
                            <option value="13">Semana 13</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Fecha Inicio:</label>
                        <input type="date" id="fechaInicio" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Fecha Fin:</label>
                        <input type="date" id="fechaFin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                    </div>
                </div>
            </div>

            <!-- Formulario de Actividades -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-6">Actividades de la Semana</h2>
                
                <div id="actividadesContainer" class="space-y-6">
                    <!-- Los días se generarán dinámicamente -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Confirmar Acción</h3>
            <p id="confirmMessage" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancel" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                    Cancelar
                </button>
                <button id="confirmOk" class="px-4 py-2 bg-primary text-white hover:bg-primary-600 rounded transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de tema oscuro
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        class HorasComplementarias {
            constructor() {
                this.dias = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES'];
                this.currentData = {};
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.generateDayForms();
                this.loadSavedData();
            }

            setupEventListeners() {
                document.getElementById('nuevaSemanBtn').addEventListener('click', () => {
                    this.showConfirm('¿Desea crear una nueva semana? Se perderán los datos no guardados.', () => {
                        this.clearForm();
                    });
                });

                document.getElementById('exportarBtn').addEventListener('click', () => {
                    this.exportToPDF();
                });

                document.getElementById('guardarBtn').addEventListener('click', () => {
                    this.saveToDatabase();
                });

                document.getElementById('cargarBtn').addEventListener('click', () => {
                    this.showLoadDialog();
                });

                document.getElementById('exportarDatosBtn').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('importarDatosBtn').addEventListener('click', () => {
                    this.importData();
                });

                document.getElementById('fechaInicio').addEventListener('change', () => {
                    this.calculateEndDate();
                });

                document.getElementById('numeroSemana').addEventListener('change', () => {
                    this.autoLoadWeek();
                });

                // Auto-save cuando se cambian los datos
                document.addEventListener('input', (e) => {
                    if (e.target.matches('input, textarea, select')) {
                        this.saveData();
                        this.updateExportButton();
                    }
                });
            }

            generateDayForms() {
                const container = document.getElementById('actividadesContainer');
                container.innerHTML = '';

                this.dias.forEach((dia, index) => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'border border-gray-200 dark:border-gray-600 rounded-lg p-4';
                    
                    dayDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">${index + 1}. ${dia}</h3>
                            <button onclick="app.toggleFeriado('${dia.toLowerCase()}')" 
                                    id="feriado-${dia.toLowerCase()}" 
                                    class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded transition-colors">
                                Marcar Feriado
                            </button>
                        </div>
                        
                        <div id="content-${dia.toLowerCase()}" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Gestión Individual:</label>
                                <textarea id="individual-${dia.toLowerCase()}" 
                                         class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base h-24 resize-vertical" 
                                         placeholder="Escriba las actividades individuales..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Gestión Participativa:</label>
                                <textarea id="participativa-${dia.toLowerCase()}" 
                                         class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base h-24 resize-vertical" 
                                         placeholder="Escriba las actividades participativas..."></textarea>
                            </div>
                        </div>
                        
                        <div id="feriado-content-${dia.toLowerCase()}" class="hidden">
                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <div class="text-2xl mb-2">🏖️</div>
                                <p class="font-medium">FERIADO</p>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(dayDiv);
                });
            }

            toggleFeriado(dia) {
                const content = document.getElementById(`content-${dia}`);
                const feriadoContent = document.getElementById(`feriado-content-${dia}`);
                const button = document.getElementById(`feriado-${dia}`);
                
                if (content.classList.contains('hidden')) {
                    // Reactivar día normal
                    content.classList.remove('hidden');
                    feriadoContent.classList.add('hidden');
                    button.textContent = 'Marcar Feriado';
                    button.className = 'px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded transition-colors';
                } else {
                    // Marcar como feriado
                    content.classList.add('hidden');
                    feriadoContent.classList.remove('hidden');
                    button.textContent = 'Quitar Feriado';
                    button.className = 'px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors';
                }
                
                this.saveData();
                this.updateExportButton();
            }

            calculateEndDate() {
                const startDate = document.getElementById('fechaInicio').value;
                if (startDate) {
                    const start = new Date(startDate);
                    // Agregar 4 días para completar la semana laboral
                    const end = new Date(start);
                    end.setDate(start.getDate() + 4);
                    document.getElementById('fechaFin').value = end.toISOString().split('T')[0];
                }
            }

            saveData() {
                this.currentData = {
                    docente: document.getElementById('docente').value,
                    tutoria: document.getElementById('tutoria').value,
                    anoLectivo: document.getElementById('anoLectivo').value,
                    asignaturas: document.getElementById('asignaturas').value,
                    numeroSemana: document.getElementById('numeroSemana').value,
                    fechaInicio: document.getElementById('fechaInicio').value,
                    fechaFin: document.getElementById('fechaFin').value,
                    actividades: {}
                };

                this.dias.forEach(dia => {
                    const diaKey = dia.toLowerCase();
                    const content = document.getElementById(`content-${diaKey}`);
                    const isFeriado = content.classList.contains('hidden');
                    
                    this.currentData.actividades[diaKey] = {
                        feriado: isFeriado,
                        individual: isFeriado ? 'FERIADO' : document.getElementById(`individual-${diaKey}`).value,
                        participativa: isFeriado ? '' : document.getElementById(`participativa-${diaKey}`).value
                    };
                });

                // Guardar en sessionStorage como respaldo
                sessionStorage.setItem('horasComplementarias', JSON.stringify(this.currentData));
            }

            loadSavedData() {
                const saved = sessionStorage.getItem('horasComplementarias');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Cargar datos básicos
                    document.getElementById('docente').value = data.docente || '';
                    document.getElementById('tutoria').value = data.tutoria || '';
                    document.getElementById('anoLectivo').value = data.anoLectivo || '';
                    document.getElementById('asignaturas').value = data.asignaturas || '';
                    document.getElementById('numeroSemana').value = data.numeroSemana || '1';
                    document.getElementById('fechaInicio').value = data.fechaInicio || '';
                    document.getElementById('fechaFin').value = data.fechaFin || '';
                    
                    // Cargar actividades
                    if (data.actividades) {
                        this.dias.forEach(dia => {
                            const diaKey = dia.toLowerCase();
                            const actividadData = data.actividades[diaKey];
                            if (actividadData) {
                                if (actividadData.feriado) {
                                    this.toggleFeriado(diaKey);
                                } else {
                                    document.getElementById(`individual-${diaKey}`).value = actividadData.individual || '';
                                    document.getElementById(`participativa-${diaKey}`).value = actividadData.participativa || '';
                                }
                            }
                        });
                    }
                    
                    this.currentData = data;
                    this.updateExportButton();
                }
            }

            clearForm() {
                document.getElementById('docente').value = 'Ing. Kevin Chica MSc.';
                document.getElementById('tutoria').value = '5to EGB';
                document.getElementById('anoLectivo').value = '2024 - 2025';
                document.getElementById('asignaturas').value = 'L.L, MAT, CCNN, E.S';
                document.getElementById('numeroSemana').value = '1';
                document.getElementById('fechaInicio').value = '';
                document.getElementById('fechaFin').value = '';
                
                this.dias.forEach(dia => {
                    const diaKey = dia.toLowerCase();
                    const content = document.getElementById(`content-${diaKey}`);
                    const feriadoContent = document.getElementById(`feriado-content-${diaKey}`);
                    const button = document.getElementById(`feriado-${diaKey}`);
                    
                    // Resetear a día normal
                    content.classList.remove('hidden');
                    feriadoContent.classList.add('hidden');
                    button.textContent = 'Marcar Feriado';
                    button.className = 'px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded transition-colors';
                    
                    document.getElementById(`individual-${diaKey}`).value = '';
                    document.getElementById(`participativa-${diaKey}`).value = '';
                });
                
                sessionStorage.removeItem('horasComplementarias');
                this.currentData = {};
                this.updateExportButton();
            }

            updateExportButton() {
                const exportBtn = document.getElementById('exportarBtn');
                const hasBasicData = this.currentData.docente && this.currentData.fechaInicio;
                exportBtn.disabled = !hasBasicData;
            }

            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = date.getDate();
                const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                               'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${day} de ${month}/${year}`;
            }

            exportToPDF() {
                if (!this.currentData.docente || !this.currentData.fechaInicio) {
                    this.showAlert('Por favor complete los datos básicos antes de exportar.');
                    return;
                }

                // Verificar que jsPDF esté disponible
                if (typeof window.jspdf === 'undefined') {
                    this.showAlert('Error: Biblioteca PDF no cargada. Intente recargar la página.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Asegurar que los datos estén actualizados
                this.saveData();
                
                // Configuración de página
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let currentY = 15;

                // ENCABEZADO CON LOGOS
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('Ministerio de Educación', margin, currentY);
                currentY += 3;
                doc.setFont(undefined, 'normal');
                doc.text('República del Ecuador', margin, currentY);
                
                // Logo centrado (Institución)
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('UNIDAD EDUCATIVA', pageWidth/2, 15, { align: 'center' });
                doc.text('"LUIS ULPIANO DE LA TORRE"', pageWidth/2, 19, { align: 'center' });
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.text('Circuito: 05D02C02_03 / Código AMIE: 05H00284', pageWidth/2, 23, { align: 'center' });
                doc.text('Correo electrónico: ueluisulpianodelatorre@hotmail.com', pageWidth/2, 26, { align: 'center' });
                doc.text('San Pedro-La Maná – Cotopaxi – Ecuador', pageWidth/2, 29, { align: 'center' });

                currentY = 40;

                // TÍTULO PRINCIPAL
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('PLAN DE TRABAJO E INFORME DE ACTIVIDADES CUMPLIDAS FUERA DE', pageWidth/2, currentY, { align: 'center' });
                currentY += 4;
                doc.text('LOS 25 PERIODOS PEDAGÓGICOS DEL DOCENTE.', pageWidth/2, currentY, { align: 'center' });
                currentY += 4;
                doc.text('Art. 263 REGLAMENTO GENERAL A LA LOEI', pageWidth/2, currentY, { align: 'center' });
                currentY += 12;

                // INFORMACIÓN DEL DOCENTE
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                const fechaInicio = this.formatDate(this.currentData.fechaInicio);
                const fechaFin = this.formatDate(this.currentData.fechaFin);
                
                doc.text(`DOCENTE: ${this.currentData.docente}`, margin, currentY);
                doc.text(`AÑO LECTIVO: ${this.currentData.anoLectivo}`, pageWidth - margin - 60, currentY);
                currentY += 5;
                
                doc.text(`SEMANA ${this.currentData.numeroSemana}: Del ${fechaInicio} al ${fechaFin}`, margin, currentY);
                currentY += 5;
                doc.text(`ASIGNATURAS: ${this.currentData.asignaturas}`, margin, currentY);
                currentY += 12;

                // TABLA CON FORMATO CORRECTO
                const rowHeight = 15;
                const colWidths = [12, 20, 25, 120]; // N°, DÍA, GESTIÓN, ACTIVIDADES
                
                // Posiciones X de las columnas
                const col1X = margin;
                const col2X = col1X + colWidths[0];
                const col3X = col2X + colWidths[1];
                const col4X = col3X + colWidths[2];

                // ENCABEZADO DE TABLA
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                
                // Dibujar bordes del encabezado
                doc.rect(col1X, currentY, colWidths[0], rowHeight);
                doc.rect(col2X, currentY, colWidths[1], rowHeight);
                doc.rect(col3X, currentY, colWidths[2], rowHeight);
                doc.rect(col4X, currentY, colWidths[3], rowHeight);
                
                // Texto del encabezado centrado
                doc.text('N°', col1X + colWidths[0]/2, currentY + rowHeight/2 + 2, { align: 'center' });
                doc.text('DÍA', col2X + colWidths[1]/2, currentY + rowHeight/2 + 2, { align: 'center' });
                doc.text('GESTIÓN', col3X + colWidths[2]/2, currentY + rowHeight/2 + 2, { align: 'center' });
                doc.text('ACTIVIDADES', col4X + colWidths[3]/2, currentY + rowHeight/2 + 2, { align: 'center' });
                
                currentY += rowHeight;

                // CONTENIDO DE LA TABLA
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                
                this.dias.forEach((dia, index) => {
                    const diaKey = dia.toLowerCase();
                    const actividadData = this.currentData.actividades?.[diaKey] || {};
                    
                    const individualText = actividadData.individual || '';
                    const participativaText = actividadData.participativa || '';
                    
                    // Calcular altura de las celdas basada en el contenido
                    const individualLines = doc.splitTextToSize(individualText, colWidths[3] - 4);
                    const participativaLines = doc.splitTextToSize(participativaText, colWidths[3] - 4);
                    
                    const individualCellHeight = Math.max(rowHeight, individualLines.length * 3 + 6);
                    const participativaCellHeight = Math.max(rowHeight, participativaLines.length * 3 + 6);
                    const totalCellHeight = individualCellHeight + participativaCellHeight;
                    
                    // Verificar si necesitamos nueva página
                    if (currentY + totalCellHeight > pageHeight - 50) {
                        doc.addPage();
                        currentY = 30;
                    }
                    
                    // DIBUJAR BORDES COMBINADOS PARA EL DÍA
                    // Columna N° y DÍA combinadas verticalmente para ambas filas
                    doc.rect(col1X, currentY, colWidths[0], totalCellHeight);
                    doc.rect(col2X, currentY, colWidths[1], totalCellHeight);
                    
                    // FILA INDIVIDUAL
                    doc.rect(col3X, currentY, colWidths[2], individualCellHeight);
                    doc.rect(col4X, currentY, colWidths[3], individualCellHeight);
                    
                    // FILA PARTICIPATIVA
                    doc.rect(col3X, currentY + individualCellHeight, colWidths[2], participativaCellHeight);
                    doc.rect(col4X, currentY + individualCellHeight, colWidths[3], participativaCellHeight);
                    
                    // CONTENIDO DE LAS CELDAS COMBINADAS
                    doc.setFont(undefined, 'bold');
                    // Número y día centrados en el espacio total
                    doc.text((index + 1).toString(), col1X + colWidths[0]/2, currentY + totalCellHeight/2 + 1, { align: 'center' });
                    doc.text(dia, col2X + colWidths[1]/2, currentY + totalCellHeight/2 + 1, { align: 'center' });
                    
                    // GESTIÓN INDIVIDUAL
                    doc.text('INDIVIDUAL', col3X + colWidths[2]/2, currentY + individualCellHeight/2 + 1, { align: 'center' });
                    
                    // Actividades individuales
                    doc.setFont(undefined, 'normal');
                    let textY = currentY + 5;
                    individualLines.forEach(line => {
                        if (line.trim()) {
                            doc.text(`• ${line}`, col4X + 2, textY);
                            textY += 3;
                        }
                    });
                    
                    // GESTIÓN PARTICIPATIVA
                    doc.setFont(undefined, 'bold');
                    doc.text('PARTICIPATIVA', col3X + colWidths[2]/2, currentY + individualCellHeight + participativaCellHeight/2 + 1, { align: 'center' });
                    
                    // Actividades participativas
                    doc.setFont(undefined, 'normal');
                    textY = currentY + individualCellHeight + 5;
                    participativaLines.forEach(line => {
                        if (line.trim()) {
                            doc.text(`• ${line}`, col4X + 2, textY);
                            textY += 3;
                        }
                    });
                    
                    currentY += totalCellHeight;
                });

                // FIRMAS
                currentY += 15;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                // Líneas para firmas
                doc.line(margin + 10, currentY, margin + 70, currentY);
                doc.line(pageWidth - margin - 70, currentY, pageWidth - margin - 10, currentY);
                
                currentY += 6;
                doc.text('Lic. Tamara Fuentes', margin + 30, currentY);
                doc.text(this.currentData.docente, pageWidth - margin - 50, currentY);
                
                currentY += 4;
                doc.text('Rector/e', margin + 40, currentY);
                doc.text('Docente', pageWidth - margin - 30, currentY);

                // FOOTER - Logo Ecuador
                const footerY = pageHeight - 20;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('ECUADOR', pageWidth/2, footerY, { align: 'center' });

                // Guardar el PDF
                const fileName = `Horas_Complementarias_Semana_${this.currentData.numeroSemana}_${this.currentData.docente.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);

                this.showAlert('PDF generado exitosamente con el formato oficial.');
            }

            showConfirm(message, onConfirm) {
                const modal = document.getElementById('confirmModal');
                const messageEl = document.getElementById('confirmMessage');
                const cancelBtn = document.getElementById('confirmCancel');
                const okBtn = document.getElementById('confirmOk');
                
                messageEl.textContent = message;
                modal.classList.remove('hidden');
                
                const hideModal = () => {
                    modal.classList.add('hidden');
                };
                
                cancelBtn.onclick = hideModal;
                okBtn.onclick = () => {
                    hideModal();
                    if (onConfirm) onConfirm();
                };
                
                // Cerrar con clic fuera del modal
                modal.onclick = (e) => {
                    if (e.target === modal) hideModal();
                };
            }

            // Nuevos métodos para persistencia
            async initDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('HorasComplementariasDB', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('semanas')) {
                            db.createObjectStore('semanas', { keyPath: 'id' });
                        }
                    };
                });
            }

            async saveToDatabase() {
                try {
                    const db = await this.initDatabase();
                    const transaction = db.transaction(['semanas'], 'readwrite');
                    const store = transaction.objectStore('semanas');
                    
                    const id = `semana-${this.currentData.numeroSemana}-${this.currentData.anoLectivo}`;
                    const dataToSave = {
                        id: id,
                        ...this.currentData,
                        fechaGuardado: new Date().toISOString()
                    };
                    
                    await store.put(dataToSave);
                    this.showAlert(`Semana ${this.currentData.numeroSemana} guardada exitosamente.`);
                } catch (error) {
                    console.error('Error guardando:', error);
                    this.showAlert('Error al guardar. Datos guardados temporalmente en el navegador.');
                }
            }

            async showLoadDialog() {
                try {
                    const db = await this.initDatabase();
                    const transaction = db.transaction(['semanas'], 'readonly');
                    const store = transaction.objectStore('semanas');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const semanas = request.result;
                        if (semanas.length === 0) {
                            this.showAlert('No hay semanas guardadas.');
                            return;
                        }
                        
                        this.createLoadModal(semanas);
                    };
                } catch (error) {
                    console.error('Error cargando:', error);
                    this.showAlert('Error al acceder a los datos guardados.');
                }
            }

            createLoadModal(semanas) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const content = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-4">Cargar Semana Guardada</h3>
                        <div class="space-y-2 mb-6">
                            ${semanas.map(semana => `
                                <button onclick="app.loadSemana('${semana.id}')" 
                                        class="w-full text-left p-3 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <div class="font-medium">Semana ${semana.numeroSemana} - ${semana.anoLectivo}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">
                                        ${semana.fechaInicio ? this.formatDate(semana.fechaInicio) : 'Sin fecha'} - 
                                        Guardado: ${new Date(semana.fechaGuardado).toLocaleDateString()}
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </div>
                `;
                
                modal.innerHTML = content;
                document.body.appendChild(modal);
                
                // Cerrar con clic fuera
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
            }

            async loadSemana(id) {
                try {
                    const db = await this.initDatabase();
                    const transaction = db.transaction(['semanas'], 'readonly');
                    const store = transaction.objectStore('semanas');
                    const request = store.get(id);
                    
                    request.onsuccess = () => {
                        const semana = request.result;
                        if (semana) {
                            this.loadDataFromObject(semana);
                            document.querySelector('.fixed').remove(); // Cerrar modal
                            this.showAlert('Semana cargada exitosamente.');
                        }
                    };
                } catch (error) {
                    console.error('Error cargando semana:', error);
                    this.showAlert('Error al cargar la semana.');
                }
            }

            loadDataFromObject(data) {
                // Cargar datos básicos
                document.getElementById('docente').value = data.docente || '';
                document.getElementById('tutoria').value = data.tutoria || '';
                document.getElementById('anoLectivo').value = data.anoLectivo || '';
                document.getElementById('asignaturas').value = data.asignaturas || '';
                document.getElementById('numeroSemana').value = data.numeroSemana || '1';
                document.getElementById('fechaInicio').value = data.fechaInicio || '';
                document.getElementById('fechaFin').value = data.fechaFin || '';
                
                // Limpiar formulario antes de cargar
                this.dias.forEach(dia => {
                    const diaKey = dia.toLowerCase();
                    const content = document.getElementById(`content-${diaKey}`);
                    const feriadoContent = document.getElementById(`feriado-content-${diaKey}`);
                    const button = document.getElementById(`feriado-${diaKey}`);
                    
                    // Resetear a día normal
                    content.classList.remove('hidden');
                    feriadoContent.classList.add('hidden');
                    button.textContent = 'Marcar Feriado';
                    button.className = 'px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded transition-colors';
                    
                    document.getElementById(`individual-${diaKey}`).value = '';
                    document.getElementById(`participativa-${diaKey}`).value = '';
                });
                
                // Cargar actividades
                if (data.actividades) {
                    this.dias.forEach(dia => {
                        const diaKey = dia.toLowerCase();
                        const actividadData = data.actividades[diaKey];
                        if (actividadData) {
                            if (actividadData.feriado) {
                                this.toggleFeriado(diaKey);
                            } else {
                                document.getElementById(`individual-${diaKey}`).value = actividadData.individual || '';
                                document.getElementById(`participativa-${diaKey}`).value = actividadData.participativa || '';
                            }
                        }
                    });
                }
                
                this.currentData = data;
                this.updateExportButton();
            }

            async autoLoadWeek() {
                const numeroSemana = document.getElementById('numeroSemana').value;
                const anoLectivo = document.getElementById('anoLectivo').value;
                
                try {
                    const db = await this.initDatabase();
                    const transaction = db.transaction(['semanas'], 'readonly');
                    const store = transaction.objectStore('semanas');
                    const id = `semana-${numeroSemana}-${anoLectivo}`;
                    const request = store.get(id);
                    
                    request.onsuccess = () => {
                        const semana = request.result;
                        if (semana) {
                            this.showConfirm(`Se encontró una semana ${numeroSemana} guardada. ¿Desea cargarla?`, () => {
                                this.loadDataFromObject(semana);
                            });
                        }
                    };
                } catch (error) {
                    // Ignorar errores silenciosamente
                }
            }

            exportData() {
                this.saveData(); // Asegurar que currentData esté actualizado
                
                const dataToExport = {
                    version: '1.0',
                    fechaExportacion: new Date().toISOString(),
                    ...this.currentData
                };
                
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `horas_complementarias_semana_${this.currentData.numeroSemana}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showAlert('Datos exportados exitosamente.');
            }

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // Validar estructura básica
                            if (!data.docente || !data.numeroSemana) {
                                this.showAlert('Archivo no válido: datos incompletos.');
                                return;
                            }
                            
                            this.showConfirm('¿Desea cargar los datos del archivo? Se perderán los datos actuales.', () => {
                                this.loadDataFromObject(data);
                                this.showAlert('Datos importados exitosamente.');
                            });
                        } catch (error) {
                            this.showAlert('Error al leer el archivo. Verifique que sea un archivo JSON válido.');
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            }

            showAlert(message) {
                this.showConfirm(message, null);
                document.getElementById('confirmCancel').style.display = 'none';
                document.getElementById('confirmOk').textContent = 'Aceptar';
            }
        }

        // Inicializar la aplicación
        const app = new HorasComplementarias();
    </script>
</body>
</html>
